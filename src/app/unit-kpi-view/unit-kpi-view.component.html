<div class="kpi-container">
  <mat-card class="kpi-card">
    <mat-card-header class="card-header">
      <mat-card-title class="card-title">Xem KPIs ƒê∆°n v·ªã - NƒÉm 2025</mat-card-title>
      <mat-card-subtitle class="card-subtitle">Theo Quy·∫øt ƒë·ªãnh 1125/QD-DHXDHN</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <div class="form-field">
        <mat-form-field appearance="fill">
          <mat-label>Ch·ªçn ƒê∆°n v·ªã</mat-label>
          <mat-select [(value)]="selectedUnit" (selectionChange)="loadKpis()">
            <mat-option *ngFor="let unit of units" [value]="unit.id">{{ unit.name }}</mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <mat-tab-group *ngIf="kpis">
        <mat-tab label="KPI Ch·ª©c nƒÉng">
          <div class="table-container">
            <mat-table [dataSource]="functionDataSource" matSort>
              <ng-container matColumnDef="stt">
                <mat-header-cell *matHeaderCellDef>STT</mat-header-cell>
                <mat-cell *matCellDef="let row">{{row.stt}}</mat-cell>
              </ng-container>
              <ng-container matColumnDef="indicator">
                <mat-header-cell *matHeaderCellDef>Ch·ªâ ti√™u</mat-header-cell>
                <mat-cell *matCellDef="let row">{{row.indicator}}</mat-cell>
              </ng-container>
              <ng-container matColumnDef="target">
                <mat-header-cell *matHeaderCellDef>M·ª•c ti√™u</mat-header-cell>
                <mat-cell *matCellDef="let row">{{row.target}}</mat-cell>
              </ng-container>
              <ng-container matColumnDef="weight">
                <mat-header-cell *matHeaderCellDef>Tr·ªçng s·ªë</mat-header-cell>
                <mat-cell *matCellDef="let row">{{row.weight}}</mat-cell>
              </ng-container>
              <ng-container matColumnDef="formula">
                <mat-header-cell *matHeaderCellDef>C√¥ng th·ª©c</mat-header-cell>
                <mat-cell *matCellDef="let row">{{row.formula}}</mat-cell>
              </ng-container>
              <ng-container matColumnDef="actual">
                <mat-header-cell *matHeaderCellDef>Th·ª±c t·∫ø</mat-header-cell>
                <mat-cell *matCellDef="let row">{{row.actual}}</mat-cell>
              </ng-container>
              <ng-container matColumnDef="score">
                <mat-header-cell *matHeaderCellDef>ƒêi·ªÉm KPI</mat-header-cell>
                <mat-cell *matCellDef="let row">{{row.score}}</mat-cell>
              </ng-container>
              <mat-header-row *matHeaderRowDef="functionColumns"></mat-header-row>
              <mat-row *matRowDef="let row; columns: functionColumns;"></mat-row>
            </mat-table>
            <div class="total-score">T·ªïng KPI Ch·ª©c nƒÉng: {{ totalFunction }}</div>
          </div>
        </mat-tab>

        <mat-tab label="KPI M·ª•c ti√™u">
          <div class="table-container">
            <mat-table [dataSource]="targetDataSource" matSort>
              <ng-container matColumnDef="stt">
                <mat-header-cell *matHeaderCellDef>STT</mat-header-cell>
                <mat-cell *matCellDef="let row">{{row.stt}}</mat-cell>
              </ng-container>
              <ng-container matColumnDef="indicator">
                <mat-header-cell *matHeaderCellDef>Ch·ªâ ti√™u</mat-header-cell>
                <mat-cell *matCellDef="let row">{{row.indicator}}</mat-cell>
              </ng-container>
              <ng-container matColumnDef="target">
                <mat-header-cell *matHeaderCellDef>M·ª•c ti√™u</mat-header-cell>
                <mat-cell *matCellDef="let row">{{row.target}}</mat-cell>
              </ng-container>
              <ng-container matColumnDef="weight">
                <mat-header-cell *matHeaderCellDef>Tr·ªçng s·ªë</mat-header-cell>
                <mat-cell *matCellDef="let row">{{row.weight}}</mat-cell>
              </ng-container>
              <ng-container matColumnDef="formula">
                <mat-header-cell *matHeaderCellDef>C√¥ng th·ª©c</mat-header-cell>
                <mat-cell *matCellDef="let row">{{row.formula}}</mat-cell>
              </ng-container>
              <ng-container matColumnDef="actual">
                <mat-header-cell *matHeaderCellDef>Th·ª±c t·∫ø</mat-header-cell>
                <mat-cell *matCellDef="let row">{{row.actual}}</mat-cell>
              </ng-container>
              <ng-container matColumnDef="score">
                <mat-header-cell *matHeaderCellDef>ƒêi·ªÉm KPI</mat-header-cell>
                <mat-cell *matCellDef="let row">{{row.score}}</mat-cell>
              </ng-container>
              <mat-header-row *matHeaderRowDef="targetColumns"></mat-header-row>
              <mat-row *matRowDef="let row; columns: targetColumns;"></mat-row>
            </mat-table>
            <div class="total-score">T·ªïng KPI M·ª•c ti√™u: {{ totalTarget }}</div>
          </div>
        </mat-tab>

        <mat-tab label="KPI Tu√¢n th·ªß">
          <div class="table-container">
            <mat-table [dataSource]="complianceDataSource" matSort>
              <ng-container matColumnDef="stt">
                <mat-header-cell *matHeaderCellDef>STT</mat-header-cell>
                <mat-cell *matCellDef="let row">{{row.stt}}</mat-cell>
              </ng-container>
              <ng-container matColumnDef="indicator">
                <mat-header-cell *matHeaderCellDef>Ch·ªâ ti√™u</mat-header-cell>
                <mat-cell *matCellDef="let row">{{row.indicator}}</mat-cell>
              </ng-container>
              <ng-container matColumnDef="target">
                <mat-header-cell *matHeaderCellDef>M·ª•c ti√™u</mat-header-cell>
                <mat-cell *matCellDef="let row">{{row.target}}</mat-cell>
              </ng-container>
              <ng-container matColumnDef="weight">
                <mat-header-cell *matHeaderCellDef>Tr·ªçng s·ªë</mat-header-cell>
                <mat-cell *matCellDef="let row">{{row.weight}}</mat-cell>
              </ng-container>
              <ng-container matColumnDef="formula">
                <mat-header-cell *matHeaderCellDef>C√¥ng th·ª©c</mat-header-cell>
                <mat-cell *matCellDef="let row">{{row.formula}}</mat-cell>
              </ng-container>
              <ng-container matColumnDef="actual">
                <mat-header-cell *matHeaderCellDef>Th·ª±c t·∫ø</mat-header-cell>
                <mat-cell *matCellDef="let row">{{row.actual}}</mat-cell>
              </ng-container>
              <ng-container matColumnDef="score">
                <mat-header-cell *matHeaderCellDef>ƒêi·ªÉm KPI</mat-header-cell>
                <mat-cell *matCellDef="let row">{{row.score}}</mat-cell>
              </ng-container>
              <mat-header-row *matHeaderRowDef="complianceColumns"></mat-header-row>
              <mat-row *matRowDef="let row; columns: complianceColumns;"></mat-row>
            </mat-table>
            <div class="total-score">T·ªïng KPI Tu√¢n th·ªß: {{ totalCompliance }}</div>
          </div>
        </mat-tab>
      </mat-tab-group>

      <div class="chart-section" *ngIf="kpis">
        <h3>Ph√¢n t√≠ch KPI</h3>
        <div class="chart-placeholder">
          <div class="pie-chart-mock"></div>
          <div class="chart-legend">
            <div class="legend-item"><span class="color-1"></span> Ch·ª©c nƒÉng ({{ totalFunction }})</div>
            <div class="legend-item"><span class="color-2"></span> M·ª•c ti√™u ({{ totalTarget }})</div>
            <div class="legend-item"><span class="color-3"></span> Tu√¢n th·ªß ({{ totalCompliance }})</div>
          </div>
        </div>
      </div>
    </mat-card-content>

    <mat-card-actions class="action-buttons">
      <button mat-raised-button color="primary" (click)="exportToExcel()">Xu·∫•t Excel</button>
      <button mat-raised-button color="accent" (click)="generateReport()">T·∫°o b√°o c√°o</button>
      <button mat-raised-button color="warn" (click)="analyzeWithAI()">Ph√¢n t√≠ch AI</button>
    </mat-card-actions>

    <div class="ai-insights" *ngIf="aiInsights">
      <h3>ü§ñ Ph√¢n t√≠ch AI</h3>
      <p>{{ aiInsights }}</p>
    </div>
  </mat-card>
</div>
