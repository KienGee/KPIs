<div class="assigned-kpis-container">
  <div class="page-header">
    <h1>KPI được giao cho Phó Hiệu trưởng</h1>
    <p class="page-subtitle">Quản lý và đánh giá các chỉ tiêu KPI được giao</p>
  </div>

  <!-- Filter Section -->
  <div class="filter-section">
    <div class="filter-group">
      <label for="periodSelect">Kỳ đánh giá:</label>
      <select 
        id="periodSelect" 
        [(ngModel)]="selectedPeriodId" 
        (change)="onPeriodChange()"
        class="form-select">
        <option value="">Tất cả kỳ</option>
        <option *ngFor="let period of evaluationPeriods" [value]="period.periodId">
          {{ period.periodName }} ({{ formatDate(period.startDate) }} - {{ formatDate(period.endDate) }})
        </option>
      </select>
    </div>
  </div>

  <!-- Error Message -->
  <div *ngIf="error" class="error-alert">
    <i class="fas fa-exclamation-triangle"></i>
    {{ error }}
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="loading-container">
    <div class="spinner"></div>
    <p>Đang tải dữ liệu...</p>
  </div>

  <!-- KPI Table -->
  <div *ngIf="!loading && !error" class="kpi-table-container">
    <div *ngIf="assignedKpis.length === 0" class="no-data">
      <i class="fas fa-inbox"></i>
      <p>Không có KPI nào được giao trong kỳ này.</p>
    </div>

    <table *ngIf="assignedKpis.length > 0" class="kpi-table">
      <thead>
        <tr>
          <th><i class="fas fa-tasks"></i> Tên KPI</th>
          <th><i class="fas fa-info-circle"></i> Mô tả</th>
          <th><i class="fas fa-tag"></i> Loại</th>
          <th><i class="fas fa-ruler"></i> Đơn vị đo</th>
          <th><i class="fas fa-bullseye"></i> Mục tiêu</th>
          <th><i class="fas fa-weight-hanging"></i> Trọng số</th>
          <th><i class="fas fa-user-check"></i> Tự đánh giá</th>
          <th><i class="fas fa-user-tie"></i> Quản lý đánh giá</th>
          <th><i class="fas fa-star"></i> Điểm cuối</th>
          <th><i class="fas fa-flag"></i> Trạng thái</th>
          <th><i class="fas fa-cogs"></i> Thao tác</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let kpi of assignedKpis" class="kpi-row">
          <td class="kpi-name">
            <strong>{{ kpi.kpiName }}</strong>
          </td>
          <td class="kpi-description">
            <div [title]="kpi.description" class="description-text">
              {{ kpi.description | slice:0:120 }}{{ kpi.description && kpi.description.length > 120 ? '...' : '' }}
            </div>
          </td>
          <td>{{ kpi.kpiType || 'N/A' }}</td>
          <td>{{ kpi.measurementUnit || 'N/A' }}</td>
          <td class="target-value">{{ formatScore(kpi.targetValue) }}</td>
          <td class="weight">{{ kpi.weightPercent }}%</td>
          <td class="self-score">{{ formatScore(kpi.evaluation?.selfAssessedScore) }}</td>
          <td class="manager-score">{{ formatScore(kpi.evaluation?.managerAssessedScore) }}</td>
          <td class="final-score">
            <strong>{{ formatScore(kpi.evaluation?.finalScore) }}</strong>
          </td>
          <td class="status">
            <span [class]="'status-badge ' + getStatusClass(kpi.evaluation?.status)">
              {{ getStatusText(kpi.evaluation?.status) }}
            </span>
          </td>
          <td class="actions">
            <button 
              class="btn btn-primary btn-sm"
              (click)="openEvaluationModal(kpi)"
              [title]="kpi.evaluation ? 'Cập nhật đánh giá' : 'Thêm đánh giá'">
              <i class="fas fa-edit"></i>
              {{ kpi.evaluation ? 'Sửa' : 'Đánh giá' }}
            </button>
            <button 
              *ngIf="kpi.evaluation?.attachments && (kpi.evaluation?.attachments?.length || 0) > 0"
              class="btn btn-secondary btn-sm ml-2"
              title="Xem minh chứng">
              <i class="fas fa-paperclip"></i>
              Minh chứng ({{ kpi.evaluation?.attachments?.length }})
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Evaluation Modal -->
<div *ngIf="showEvaluationModal" class="modal-overlay" (click)="closeEvaluationModal()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Đánh giá KPI</h3>
      <button class="close-btn" (click)="closeEvaluationModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="modal-body" *ngIf="selectedKpi">
      <div class="kpi-info">
        <h4>{{ selectedKpi.kpiName }}</h4>
        <p class="kpi-desc">{{ selectedKpi.description }}</p>
        <div class="kpi-details">
          <span class="detail-item">
            <strong>Mục tiêu:</strong> {{ formatScore(selectedKpi.targetValue) }}
          </span>
          <span class="detail-item">
            <strong>Trọng số:</strong> {{ selectedKpi.weightPercent }}%
          </span>
          <span class="detail-item">
            <strong>Kỳ:</strong> {{ selectedKpi.periodName }}
          </span>
        </div>
      </div>

      <form class="evaluation-form">
        <div class="form-group">
          <label for="selfScore">Điểm tự đánh giá (0-1):</label>
          <input 
            type="number" 
            id="selfScore"
            [(ngModel)]="evaluationForm.selfAssessedScore"
            name="selfScore"
            min="0" 
            max="1" 
            step="0.01"
            class="form-input"
            placeholder="Nhập điểm từ 0 đến 1">
          <small class="form-help">Ví dụ: 0.95 = 95%, 0.8 = 80%</small>
        </div>

        <div class="form-group">
          <label for="selfComment">Nhận xét tự đánh giá:</label>
          <textarea 
            id="selfComment"
            [(ngModel)]="evaluationForm.selfComment"
            name="selfComment"
            class="form-textarea"
            rows="4"
            placeholder="Nhập nhận xét về việc thực hiện KPI này..."></textarea>
        </div>

        <div *ngIf="selectedKpi && selectedKpi.evaluation && selectedKpi.evaluation.managerAssessedScore" class="manager-evaluation">
          <h5>Đánh giá từ Ban Giám hiệu:</h5>
          <p><strong>Điểm:</strong> {{ formatScore(selectedKpi.evaluation.managerAssessedScore) }}</p>
          <p *ngIf="selectedKpi.evaluation.managerComment">
            <strong>Nhận xét:</strong> {{ selectedKpi.evaluation.managerComment }}
          </p>
        </div>
      </form>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeEvaluationModal()">
        Hủy
      </button>
      <button class="btn btn-primary" (click)="submitEvaluation()">
        <i class="fas fa-save"></i>
        Lưu đánh giá
      </button>
    </div>
  </div>
</div>